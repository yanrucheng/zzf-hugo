{{/*
  Gallery Item Shortcode
  ----------------------
  A single media item with hover info effect and configurable aspect ratio.
  Looks like reveal photographic gallery with no rounded corners.

  Parameters:
  - src: Path to media file (required)
  - alt: Alt text for media (optional, defaults to filename)
  - title: Title text for hover card (optional)
  - desc: Description text for hover card (optional)
  - ratio: Aspect ratio class (optional, defaults to 16:9)
    Available ratios: 2:3, 3:2, 1:1, 16:9, 9:16, 1:2.5, 1:3.5
  - class: Additional custom classes (optional)

  Usage:
  {{< gallery-item src="image.jpg" alt="Image" title="My Image" desc="Description" ratio="1:1" >}}
*/}}
{{- $src := .Get "src" | default "" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $title := .Get "title" | default "" -}}
{{- $desc := .Get "desc" | default "" -}}
{{- $ratio := .Get "ratio" | default "16:9" -}}
{{- $class := .Get "class" | default "" -}}

{{- if not $src -}}
  {{- errorf "The 'gallery-item' shortcode requires a 'src' parameter." -}}
{{- end -}}

{{- $fileName := path.Base $src -}}
{{- $alt := cond (not $alt) (humanize (strings.TrimSuffix (path.Ext $fileName) $fileName)) $alt -}}

{{- /* Simplified ratio handling using a map */ -}}
{{- $ratioMap := dict "2:3" (dict "w" 2 "h" 3) "3:2" (dict "w" 3 "h" 2) "1:1" (dict "w" 1 "h" 1) "16:9" (dict "w" 16 "h" 9) "9:16" (dict "w" 9 "h" 16) "1:2.5" (dict "w" 1 "h" 2.5) "1:3.5" (dict "w" 1 "h" 3.5) -}}
{{- $defaultRatio := dict "w" 16 "h" 9 -}}

{{- $currentRatio := index $ratioMap $ratio | default $defaultRatio -}}
{{- $rw := $currentRatio.w -}}
{{- $rh := $currentRatio.h -}}

{{- /* Calculate ratio class dynamically */ -}}
{{- $ratioClass := cond (eq $rw $rh) "aspect-square" (cond (eq $ratio "16:9") "aspect-video" (printf "aspect-[%d/%d]" $rw $rh)) -}}

{{- $mediaType := "" -}}
{{- $resource := .Page.Resources.GetMatch $src -}}
{{- $isVideo := false -}}

{{- with $resource -}}
  {{- $mediaType = .ResourceType -}}
  {{- if eq $mediaType "video" -}}
    {{- $isVideo = true -}}
  {{- end -}}
{{- else -}}
  {{- $ext := path.Ext $src -}}
  {{- $videoExts := slice ".mp4" ".webm" ".ogg" ".mov" -}}
  {{- $isVideo = in $videoExts $ext -}}
{{- end -}}

<div class="gallery-item relative overflow-hidden {{ $ratioClass }} {{ $class }}"
     style="--rw: {{ $rw }}; --rh: {{ $rh }};">
  <figure class="m-0 h-full w-full">
    {{- if $isVideo -}}
      {{- if $resource -}}
        <video
          src="{{ $resource.RelPermalink }}"
          alt="{{ $alt }}"
          preload="lazy"
          muted
          playsinline
          class="gallery-media h-full w-full object-cover transition-transform duration-300 ease-in-out hover:scale-105"
        ></video>
      {{- else -}}
        <video
          src="{{ $src }}"
          alt="{{ $alt }}"
          preload="lazy"
          muted
          playsinline
          class="gallery-media h-full w-full object-cover transition-transform duration-300 ease-in-out hover:scale-105"
        ></video>
      {{- end -}}
    {{- else -}}
      {{- if $resource -}}
        <img
          src="{{ $resource.RelPermalink }}"
          alt="{{ $alt }}"
          class="gallery-media h-full w-full object-cover transition-transform duration-300 ease-in-out hover:scale-105"
        >
      {{- else -}}
        <img
          src="{{ $src }}"
          alt="{{ $alt }}"
          class="gallery-media h-full w-full object-cover transition-transform duration-300 ease-in-out hover:scale-105"
        >
      {{- end -}}
    {{- end -}}

    {{- if or $title $desc -}}
      <figcaption class="gallery-caption absolute left-0 right-0 bottom-0 p-4 bg-gradient-to-t from-black/70 to-transparent text-white opacity-0 transition-opacity duration-300 hover:opacity-100">
        {{- with $title -}}
          <h3 class="text-lg font-semibold mb-1">{{ . }}</h3>
        {{- end -}}
        {{- with $desc -}}
          <p class="text-sm">{{ . }}</p>
        {{- end -}}
      </figcaption>
    {{- end -}}
  </figure>
</div>
