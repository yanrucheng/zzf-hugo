{{- $src := .Get "src" -}}
{{- $custom_class := .Get "class" | default "" -}}
{{- $is_parallax := .Get "parallax" | default "false" | eq "true" -}}
{{- $is_grayout := .Get "grayout" | default "false" | eq "true" -}}
{{- $grayout_speed := .Get "grayout_speed" | default 2.0 -}}
{{- $initial_gray := .Get "initial_gray" | default 100 -}}

{{- with .Page.Resources.GetMatch $src -}}
  <div class="overflow-hidden relative {{ $custom_class }}
  {{ if $is_parallax }} h-50vh {{ else }} h-100vh {{ end }}"
  >
    <div class="
      {{ if $is_parallax }} parallax-background {{ end }}
      {{ if $is_grayout }} scroll-grayout {{ end }}
      absolute left-0 w-100 h-100 cover bg-center z-1"
      style="background-image: url({{ .RelPermalink }})">
    </div>
    <div>
      <div class="z-2 relative">
        <!-- Content goes here -->
      </div>
    </div>
  </div>

  <script>
    // Utility function to apply effects
    function applyEffectToElements(selector, callback) {
      const elements = document.querySelectorAll(selector);

      elements.forEach((element) => {
        const box = element.getBoundingClientRect();
        const t = box.top;
        const b = box.bottom;

        if (t < window.innerHeight && b > 0) {
          callback(element, t, b, false); // box fully or partially in view
        } else {
          callback(element, t, b, true); // box out of view
        }
      });
    }

    // Scroll Image Effect Module
    function scrollGrayoutEffect() {
      applyEffectToElements(".scroll-grayout", (element, t, b, outOfView) => {
        const initialGray = {{ $initial_gray }};
        const scrollSpeedFactor = {{ $grayout_speed }};

        if (outOfView) {
          element.style.filter = `grayscale(${initialGray}%)`;
        } else {
          // touching bottom = 0, touching top = 1
          const scrollPercentage = (window.innerHeight - b) / (window.innerHeight - b + t);
          const grayscalePercentage = Math.max( 0, Math.min(1,
            // y = -ax + b
            // 0.5 = -a0.5 + b
            // a = scrollSpeedFactor
            // b = 0.5 + 0.5a = (1 + a) / 2
            // y = -ax + b = -ax + a/2 + 1/2 = scrollSpeedFactor * (1/2 - scrollPercentage) + 1/2
            scrollSpeedFactor * (1/2 - scrollPercentage) + 1/2
          )) * initialGray;
          element.style.filter = `grayscale(${grayscalePercentage}%)`;
        }
      });
    }

    // Parallax Background Effect Module
    function parallaxBackgroundEffect() {
      applyEffectToElements(".parallax-background", (element, t, _) => {
        const scrollPercentage = t / window.innerHeight;
        element.style.backgroundPositionY = `${scrollPercentage * 50}%`;
      });
    }

    // Main scroll event handler
    function handleScroll() {
      scrollGrayoutEffect();
      parallaxBackgroundEffect();
    }

    // Attach scroll event
    window.addEventListener("scroll", handleScroll);
  </script>
{{- end -}}
